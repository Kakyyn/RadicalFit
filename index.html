<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PWA and Apple Touch Icon -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/Kakyyn/RadicalFit/5e7e4575e3f7dab9ac0cf03d74d527b9cb3d1c07/logo180.png">
    <link rel="icon" type="image/png" sizes="180x180" href="https://raw.githubusercontent.com/Kakyyn/RadicalFit/5e7e4575e3f7dab9ac0cf03d74d527b9cb3d1c07/logo180.png">
    <link rel="stylesheet" href="main.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Radical Fit</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- html5-qrcode CDN was returning 404 for some versions; provide a safe feature-detect stub as fallback -->
    <script>
        (function() {
            // If Html5Qrcode is already loaded by a valid script, do nothing
            if (typeof window.Html5Qrcode !== 'undefined') return;
            // Otherwise provide a lightweight stub that mirrors the API used in main.js
            function StubHtml5Qrcode(elementId) {
                this._elementId = elementId;
            }
            StubHtml5Qrcode.prototype.start = function(constraints, config, qrSuccessCallback, qrErrorCallback) {
                // Return a rejected promise to simulate inability to start camera
                return Promise.reject(new Error('Html5Qrcode library not available. Scanning is disabled.'));
            };
            StubHtml5Qrcode.prototype.stop = function() { return Promise.resolve(); };
            StubHtml5Qrcode.prototype.clear = function() { return Promise.resolve(); };
            window.Html5Qrcode = StubHtml5Qrcode;
        })();
    </script>
</head>
<body>
    <!-- Landing Page -->
    <div id="landingPage" class="landing-container">
        <div class="landing-content">
            <img src="https://raw.githubusercontent.com/Kakyyn/RadicalFit/5e7e4575e3f7dab9ac0cf03d74d527b9cb3d1c07/logo.png" alt="Radical Fit Logo" class="logo-landing-img">
            <p class="landing-subtitle">Transforma tu cuerpo.</p>
            
            <div class="landing-tabs">
                <button class="landing-tab active" data-tab="info">Informaci√≥n</button>
                <button class="landing-tab" data-tab="login">Iniciar Sesi√≥n</button>

            </div>
            <div id="gymInfo" class="landing-tab-content gym-info active">
                <h3>Acerca de Nuestro Gimnasio</h3>
                <p>¬°Bienvenido a Radical Fit! Ofrecemos equipos de √∫ltima generaci√≥n y programas de entrenamiento personalizados para ayudarte a alcanzar tus objetivos de fitness.</p>
                
                <ul class="plans-list">
                    <li class="plan-item" data-plan="nitro">
                        <span class="plan-name">Nitro</span>
                    </li>
                    <li class="plan-item" data-plan="zero">
                        <span class="plan-name">Body Clean</span>
                    </li>
                    <li class="plan-item" data-plan="tnt">
                        <span class="plan-name">After Party</span>
                    </li>
                    <li class="plan-item" data-plan="gainer">
                        <span class="plan-name">Gainer</span>
                    </li>
                </ul>
                <!-- Plan Info Modal -->
                <div id="planInfoModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title" id="planModalTitle">Informaci√≥n del Plan</h2>
                            <button class="close-btn" id="closePlanModal">&times;</button>
                        </div>
                        <div id="planModalBody"></div>
                    </div>
                </div>
            </div>
            <div id="loginTab" class="landing-tab-content">
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label">Correo Electr√≥nico</label>
                        <input type="email" class="form-input" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-input" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Iniciar Sesi√≥n</button>
                    <div id="loginError" class="error-message"></div>
                </form>
            </div>
            
            <div class="btn-group">
                <button id="registerBtn" class="btn btn-primary">Registrar Nuevo Miembro</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="app-container hidden">
        <!-- Hamburger menu button (moved here) -->
    <button class="menu-toggle" id="menuToggleBtn">‚ò∞</button>
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="https://raw.githubusercontent.com/Kakyyn/RadicalFit/5e7e4575e3f7dab9ac0cf03d74d527b9cb3d1c07/logo.png" alt="Radical Fit Logo" class="sidebar-logo-img">
            </div>
            <nav>
                <ul class="nav-menu" id="navMenu">
                    <!-- Navigation items will be populated by JavaScript -->
                </ul>
                <div class="signout-wrap">
                    <button id="signOutBtn" class="btn btn-danger signout-btn">Cerrar Sesi√≥n</button>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="header">
                <h1 class="page-title" id="pageTitle">Tablero <span id="memberPlanLabel" class="plan-label hidden"></span></h1>
                <div class="user-info">
                    <span id="userEmail"></span>
                </div>
            </header>

            <!-- Member Dashboard -->
            <div id="memberDashboard" class="hidden">
                <div id="weighinReminder" class="weighin-reminder"></div>
                <div class="card-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-title">ID de Miembro</div>
                        <div class="stat-value" id="memberId"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìÖ</div>
                        <div class="stat-title">Mediciones</div>
                        <div class="stat-value" id="memberMeasurementMessage"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-title">Asistencia</div>
                        <div class="stat-value" id="attendanceCount">0</div>
                    </div>
                </div>

                <div class="member-dashboard-tabs">
                    <!-- Las pesta√±as ahora se controlan desde la barra lateral -->
                </div>

                <div id="qrTab" class="card">
                    <div class="card-header">
                        <h3 class="card-title">Tu C√≥digo QR</h3>
                    </div>
                    <div class="qr-container" id="memberProfileQR"></div>
                    <div id="weighinReminder" class="weighin-reminder"></div>
                    <p class="qr-note">Muestra este c√≥digo QR para la asistencia</p>
                </div>

                <div id="profileTab" class="card hidden">
                    <div class="card-header">
                        <h3 class="card-title">Informaci√≥n Personal</h3>
                    </div>
                    <div id="memberProfile">
                        <div><strong>Nombre:</strong> <span id="memberProfileName"></span></div>
                        <div><strong>Email:</strong> <span id="memberProfileEmail"></span></div>
                        <div><strong>Tel√©fono:</strong> <span id="memberProfilePhone"></span></div>
                        <div><strong>Fecha de Nacimiento:</strong> <span id="memberProfileDob"></span></div>
                        <div><strong>Peso:</strong> <span id="memberProfileWeight"></span></div>
                    </div>
                    <div class="member-images" id="memberImages">
                        <div class="image-card">
                            <h4>Antes</h4>
                            <div id="beforeImage"></div>
                        </div>
                        <div class="image-card">
                            <h4>Despu√©s</h4>
                            <div id="afterImage"></div>
                        </div>
                    </div>
                </div>

                <div id="measurementsTab" class="card hidden">
                    <div class="card-header">
                        <h3 class="card-title">Mediciones Corporales</h3>
                    </div>
                    
                    <!-- Original Measurements (Registration Data) -->
                    <div class="mt-16">
                        <h4 class="section-title-yellow">üìè Mediciones Iniciales (Registro)</h4>
                        <div id="originalMeasurements" class="orig-measurements">
                            <div><strong>Fecha de Registro:</strong> <span id="memberRegistrationDate"></span></div>
                            <div><strong>Peso:</strong> <span id="memberOriginalWeight"></span></div>
                            <div><strong>Abdomen:</strong> <span id="memberOriginalAbdomen"></span></div>
                            <div><strong>Cintura:</strong> <span id="memberOriginalCintura"></span></div>
                            <div><strong>Cadera:</strong> <span id="memberOriginalCadera"></span></div>
                            <div><strong>Pierna:</strong> <span id="memberOriginalPierna"></span></div>
                            <div><strong>Brazo:</strong> <span id="memberOriginalBrazo"></span></div>
                            <div><strong>Espalda:</strong> <span id="memberOriginalEspalda"></span></div>
                        </div>
                    </div>

                    <!-- Measurement History -->
                    <div>
                        <h4 class="section-title-yellow">üìä Historial de Mediciones</h4>
                        <div id="measurementHistory" class="measurement-history">
                            <p class="muted muted-centered">No hay mediciones adicionales registradas</p>
                        </div>
                    </div>
                    
                </div>

                <div id="ejerciciosMemberTab" class="card hidden">
                    <div class="card-header">
                        <h3 class="card-title">Ejercicios Asignados</h3>
                    </div>
                    <div id="memberEjerciciosList" class="member-exercises-list"></div>
                </div>

                <div id="progressTab" class="card hidden">
                    <div class="card-header">
                        <h3 class="card-title">Seguimiento de Progreso</h3>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Peso Actual</div>
                        <div class="stat-value" id="currentWeight">N/A</div>
                    </div>
                    <div id="weightHistory"></div>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="hidden">
                <div class="card-grid" id="adminCardGrid">
                    <div class="stat-card">
                        <div class="stat-icon">üë•</div>
                        <div class="stat-title">Total de Miembros</div>
                        <div class="stat-value" id="totalMembers">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-title">Asistencias de Hoy</div>
                        <div class="stat-value" id="todayCheckins">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-title">Este Mes</div>
                        <div class="stat-value" id="monthlyCheckins">0</div>
                    </div>
                </div>

                <div class="card" id="miembrosTab">
                    <div class="card-header">
                        <h3 class="card-title">Gesti√≥n de Miembros</h3>
                        <div class="btn-group">
                            <button id="scanQRBtn" class="btn btn-secondary">Escanear C√≥digo QR</button>
                            <button id="addMemberBtn" class="btn btn-primary">Agregar Miembro</button>
                        </div>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Correo Electr√≥nico</th>
                                <th>Tel√©fono</th>
                                <th class="text-center">Asistencia</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="membersTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Ejercicios admin tab -->
                <div class="card hidden" id="ejerciciosTab" class="mt-32">
                    <div class="card-header">
                        <h3 class="card-title">Ejercicios (Admin)</h3>
                        <div class="btn-group">
                            <button id="addExerciseBtn" class="btn btn-primary">Agregar Ejercicio</button>
                            <button id="assignExerciseBtn" class="btn btn-secondary">Asignar a Miembro</button>
                        </div>
                    </div>
                    <div id="exercisesList" class="exercises-list"></div>
                </div>

                <!-- Compras Tab Content -->
                <div class="card hidden" id="comprasTab" class="mt-32">
                    <div class="card-header">
                        <h3 class="card-title">Compras</h3>
                        <div class="btn-group">
                            <button id="registrarCompraBtn" class="btn btn-primary">Registrar compra</button>
                            <button id="elegirGanadorBtn" class="btn btn-success">Elegir ganador</button>
                        </div>
                    </div>
                    <div id="comprasWinner" class="compras-winner-wrap"></div>
                    <ul id="comprasList" class="compras-list"></ul>
                </div>

                <!-- Purchase Modal -->
                <div id="purchaseModal" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 class="modal-title">Registrar Compra</h2>
                            <button class="close-btn" id="closePurchaseModal">&times;</button>
                        </div>
                        <div class="center-block">
                            <input id="purchaseManualIdInput" type="text" placeholder="Ingresar ID o nombre de miembro" class="purchase-input">
                            <button id="purchaseManualIdBtn" class="btn btn-primary btn-sm ml-8">Registrar</button>
                        </div>
                        <div id="purchaseResult" class="success-message center-mt-16"></div>
                    </div>
                </div>
                </div>
                <div class="card hidden" id="ajustesTab" class="mt-32">
                    <div class="card-header">
                        <h3 class="card-title">Ajustes</h3>
                    </div>
                    <div class="center-flex-col">
                        <button id="resetAllBtn" class="btn btn-danger btn-wide">Eliminar todos los datos</button>
                        <button id="exportDataBtn" class="btn btn-secondary btn-wide">Exportar datos</button>
                        <label for="importDataInput">
                            <input id="importDataInput" type="file" accept="application/json" class="hidden">
                            <span class="btn btn-secondary btn-wide">Importar datos</span>
                        </label>
                    </div>
                    <div id="settingsMessage" class="error-message mt-16 text-center"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Registrar Nuevo Miembro</h2>
                <button class="close-btn" id="closeRegisterModal">&times;</button>
            </div>
            <form id="registerForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" id="regName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tel√©fono</label>
                        <input type="tel" class="form-input" id="regPhone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Correo Electr√≥nico</label>
                        <input type="email" class="form-input" id="regEmail" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-input" id="regPassword" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fecha de Nacimiento</label>
                        <input type="date" class="form-input" id="regDob" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" class="form-input" id="regWeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Plan</label>
                        <select class="form-input" id="regPlanType">
                            <option value="in_person">Presencial</option>
                            <option value="virtual">Virtual</option>
                            <option value="gladiadores">Gladiadores</option>
                        </select>
                    </div>
                </div>
                <h4 class="section-title">Im√°genes (opcional)</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Imagen Antes</label>
                        <input type="file" class="form-input" id="regBeforeImg" accept="image/*">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Imagen Despu√©s</label>
                        <input type="file" class="form-input" id="regAfterImg" accept="image/*">
                    </div>
                </div>

                <h4 class="section-title">Medidas Corporales (cm)</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Abdomen</label>
                        <input type="number" class="form-input" id="regAbdomen" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cintura</label>
                        <input type="number" class="form-input" id="regCintura" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cadera</label>
                        <input type="number" class="form-input" id="regCadera" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pierna</label>
                        <input type="number" class="form-input" id="regPierna" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brazo</label>
                        <input type="number" class="form-input" id="regBrazo" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Espalda</label>
                        <input type="number" class="form-input" id="regEspalda" step="0.1" required>
                    </div>
                </div>

                <h4 class="section-title">Medidas de Ropa</h4>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Pantal√≥n</label>
                        <input type="text" class="form-input" id="regPantalon" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Camisa</label>
                        <input type="text" class="form-input" id="regCamisa" required>
                    </div>
                </div>
                
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelRegister">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Registrar Miembro</button>
                </div>
                <div id="registerError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Informaci√≥n</h2>
                <button class="close-btn" id="closeEditModal">&times;</button>
            </div>
            <!-- Modal Tab Bar -->
            <div class="member-tabs-scroll">
                <button type="button" class="btn btn-sm btn-secondary member-tab-btn active tab-min-w-90" data-tab="datosTab">Datos</button>
                <button type="button" class="btn btn-sm btn-secondary member-tab-btn tab-min-w-120" data-tab="factoresSaludTab">Factores de Salud</button>
                <button type="button" class="btn btn-sm btn-secondary member-tab-btn tab-min-w-120" data-tab="saludMovilidadTab">Salud/Movilidad</button>
            </div>
            <form id="editForm">

                <input type="hidden" id="editMemberId">
                <!-- Tab Content Areas -->
                <div id="datosTab" class="tab-content-area" data-visible="true">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Nombre Completo</label>
                            <input type="text" class="form-input" id="editName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tel√©fono</label>
                            <input type="tel" class="form-input" id="editPhone" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Correo Electr√≥nico</label>
                            <input type="email" class="form-input" id="editEmail" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nueva Contrase√±a (dejar en blanco para mantener la actual)</label>
                            <input type="password" class="form-input" id="editPassword">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-input" id="editDob" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" class="form-input" id="editWeight" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo de Plan</label>
                            <select class="form-input" id="editPlanType">
                                <option value="in_person">Presencial</option>
                                <option value="virtual">Virtual</option>
                                <option value="gladiadores">Gladiadores</option>
                            </select>
                        </div>
                    </div>
                    <h4 class="section-title">Medidas Corporales (cm)</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Abdomen</label>
                            <input type="number" class="form-input" id="editAbdomen" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cintura</label>
                            <input type="number" class="form-input" id="editCintura" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Cadera</label>
                            <input type="number" class="form-input" id="editCadera" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Pierna</label>
                            <input type="number" class="form-input" id="editPierna" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Brazo</label>
                            <input type="number" class="form-input" id="editBrazo" step="0.1">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Espalda</label>
                            <input type="number" class="form-input" id="editEspalda" step="0.1">
                        </div>
                    </div>
                    <h4 class="section-title">Medidas de Ropa</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Pantal√≥n</label>
                            <input type="text" class="form-input" id="editPantalon">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Camisa</label>
                            <input type="text" class="form-input" id="editCamisa">
                        </div>
                    </div>
                    <h4 class="section-title">Im√°genes</h4>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Imagen Antes</label>
                            <input type="file" class="form-input" id="editBeforeImg" accept="image/*">
                            <img id="editBeforePreview" src="" alt="Vista previa antes" class="img-preview small" />
                        </div>
                        <div class="form-group">
                            <label class="form-label">Imagen Despu√©s</label>
                            <input type="file" class="form-input" id="editAfterImg" accept="image/*">
                            <img id="editAfterPreview" src="" alt="Vista previa despu√©s" class="img-preview small" />
                        </div>
                    </div>
                </div>

                <div id="factoresSaludTab" class="tab-content-area" data-visible="false">
                    <h4 class="section-title-yellow">Factores de Salud</h4>
                    <div class="form-group">
                        <label class="form-label">Selecciona los factores que aplican:</label>
                        <div class="checkbox-column mt-12">
                            <label><input type="checkbox" id="faltaEnergia"> Falta de energ√≠a</label>
                            <label><input type="checkbox" id="excesoEstres"> Exceso de estr√©s</label>
                            <label><input type="checkbox" id="descontrolHormonal"> Descontrol hormonal</label>
                            <label><input type="checkbox" id="estrias"> Estr√≠as</label>
                            <label><input type="checkbox" id="celulitis"> Celulitis</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Flacidez (1-10):</label>
                        <select class="form-input" id="flacidezNivel">
                            <option value="">Selecciona</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                            <option value="7">7</option>
                            <option value="8">8</option>
                            <option value="9">9</option>
                            <option value="10">10</option>
                        </select>
                    </div>
                </div>
                <div id="saludMovilidadTab" class="tab-content-area" data-visible="false">
                    <h4 class="section-title-yellow">Salud/Movilidad</h4>
                    <div class="form-group">
                        <label class="form-label">Selecciona los factores que aplican:</label>
                        <div class="checkbox-column mt-12">
                            <label><input type="checkbox" id="trigliceridos"> Triglic√©ridos</label>
                            <label><input type="checkbox" id="colesterol"> Colesterol</label>
                            <label><input type="checkbox" id="diabetes"> Diabetes</label>
                            <label><input type="checkbox" id="higadoGraso"> H√≠gado Graso</label>
                            <label><input type="checkbox" id="piedrasVesicula"> Piedras en Ves√≠cula</label>
                            <label><input type="checkbox" id="prediabetes"> Prediabetes</label>
                            <label><input type="checkbox" id="reflujo"> Reflujo</label>
                            <label><input type="checkbox" id="gastritis"> Gastritis</label>
                            <label><input type="checkbox" id="colitis"> Colitis</label>
                            <label><input type="checkbox" id="piedrasRinon"> Piedras en Ri√±√≥n</label>
                            <label><input type="checkbox" id="retencionLiquidos"> Retenci√≥n de L√≠quidos</label>
                            <label><input type="checkbox" id="faltaEnergia2"> Falta de Energ√≠a</label>
                            <label><input type="checkbox" id="estrenimiento"> Estre√±imiento</label>
                            <label><input type="checkbox" id="migra√±as"> Migra√±as</label>
                            <label><input type="checkbox" id="cansancio"> Cansancio o falta de aire</label>
                            <label><input type="checkbox" id="meCuestaLevantarme"> Me cuesta levantarme</label>
                            <label><input type="checkbox" id="meCuestaAgacharme"> Me cuesta agacharme a tomar algo</label>
                            <label><input type="checkbox" id="pocaResistencia"> Poca resistencia de entrenamiento</label>
                            <label><input type="checkbox" id="meCuestaEstirarme"> Me cuesta estirarme</label>
                            <label><input type="checkbox" id="dolorCaminar"> Dolor al caminar o subir escaleras</label>
                            <label><input type="checkbox" id="doloresArticulares"> Dolores Articulares</label>
                            <label><input type="checkbox" id="meCuestaDormir"> Me cuesta dormir o ronco</label>
                            <label><input type="checkbox" id="meCuestaConducir"> Me cuesta conducir al volante</label>
                            <label><input type="checkbox" id="noPuedoAgacharme"> No puedo agacharme para amarrame los zapatos</label>
                            <label><input type="checkbox" id="nervioCiatico"> Se me inflama el nervio ci√°tico</label>
                            <label><input type="checkbox" id="meDuelenHuesos"> Me duelen huesos o articulaciones</label>
                            <label><input type="checkbox" id="seArrollaRopa"> Se me arrolla la ropa interior</label>
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-danger" id="deleteMember">Eliminar Miembro</button>
                    <button type="button" class="btn btn-secondary edit-only" id="cancelEdit">Cancelar</button>
                    <button type="submit" class="btn btn-primary edit-only">Guardar Cambios</button>
                </div>
                <div id="editError" class="error-message"></div>
                <div id="editSuccess" class="success-message"></div>
            </form>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div id="scannerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Escanear C√≥digo QR del Miembro</h2>
                <button class="close-btn" id="closeScannerModal">&times;</button>
            </div>
            <div id="qr-reader" class="qr-reader-wrap"></div>
            <div class="center-block">
                <input id="manualIdInput" type="text" placeholder="Ingresar ID de miembro" class="purchase-input">
                <button id="manualIdBtn" class="btn btn-primary btn-sm ml-8">Agregar Asistencia</button>
            </div>
            <div id="scanResult" class="success-message center-mt-16"></div>
        </div>
    </div>

    <!-- Measurement Modal -->
    <div id="measurementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Medici√≥n</h2>
                <button class="close-btn" id="closeMeasurementModal">&times;</button>
            </div>
            <form id="measurementForm">
                <input type="hidden" id="measurementMemberId">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-input" id="measurementDate">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Peso (kg)</label>
                        <input type="number" class="form-input" id="measurementWeight" step="0.1" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Abdomen (cm)</label>
                        <input type="number" class="form-input" id="measurementAbdomen" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cintura (cm)</label>
                        <input type="number" class="form-input" id="measurementCintura" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cadera (cm)</label>
                        <input type="number" class="form-input" id="measurementCadera" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pierna (cm)</label>
                        <input type="number" class="form-input" id="measurementPierna" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Brazo (cm)</label>
                        <input type="number" class="form-input" id="measurementBrazo" step="0.1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Espalda (cm)</label>
                        <input type="number" class="form-input" id="measurementEspalda" step="0.1">
                    </div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelMeasurement">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Medici√≥n</button>
                </div>
                <div id="measurementError" class="error-message"></div>
                <div id="measurementSuccess" class="success-message"></div>
            </form>
        </div>
    </div>
    <!-- Add Exercise Modal -->
    <div id="addExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar Ejercicio</h2>
                <button class="close-btn" id="closeAddExerciseModal">&times;</button>
            </div>
            <form id="addExerciseForm">
                <div class="form-group">
                    <label class="form-label">T√≠tulo</label>
                    <input type="text" class="form-input" id="exerciseTitle" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" id="exerciseDescription" rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">URL de Video (opcional)</label>
                    <input type="url" class="form-input" id="exerciseVideo">
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelAddExercise">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Ejercicio</button>
                </div>
                <div id="exerciseError" class="error-message"></div>
                <div id="exerciseSuccess" class="success-message"></div>
            </form>
        </div>
    </div>

    <!-- Assign Exercise Modal -->
    <div id="assignExerciseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Asignar Ejercicio a Miembro</h2>
                <button class="close-btn" id="closeAssignExerciseModal">&times;</button>
            </div>
            <div class="mt-12">
                <label class="form-label">Seleccionar Ejercicio</label>
                <select id="assignExerciseSelect" class="form-input"></select>
            </div>
            <div class="mt-12">
                <label class="form-label">Seleccionar Miembro</label>
                <select id="assignMemberSelect" class="form-input"></select>
            </div>
            <div class="flex-gap">
                <div class="flex-1">
                    <label class="form-label">Series (sets)</label>
                    <input id="assignSetsInput" class="form-input" type="number" min="1" value="3">
                </div>
                <div class="flex-1">
                    <label class="form-label">Repeticiones (reps)</label>
                    <input id="assignRepsInput" class="form-input" type="number" min="1" value="10">
                </div>
            </div>
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" id="cancelAssignExercise">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmAssignExercise">Asignar</button>
            </div>
            <div id="assignError" class="error-message"></div>
            <div id="assignSuccess" class="success-message"></div>
        </div>
    </div>

        <!-- Edit Exercise Modal -->
        <div id="editExerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Editar Ejercicio</h2>
                    <button class="close-btn" id="closeEditExerciseModal">&times;</button>
                </div>
                <form id="editExerciseForm">
                    <input type="hidden" id="editExerciseId">
                    <div class="form-group">
                        <label class="form-label">T√≠tulo</label>
                        <input type="text" class="form-input" id="editExerciseTitle" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n</label>
                        <textarea class="form-input" id="editExerciseDescription" rows="4"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">URL de Video (opcional)</label>
                        <input type="url" class="form-input" id="editExerciseVideo">
                    </div>
                    <div id="editExercisePreview" class="center-mt-16"></div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-secondary" id="cancelEditExercise">Cancelar</button>
                        <button id="editExerciseSaveBtn" type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                    <div id="editExerciseError" class="error-message"></div>
                    <div id="editExerciseSuccess" class="success-message"></div>
                </form>
            </div>
        </div>

        <!-- Unassign Exercise Modal -->
        <div id="unassignExerciseModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Desasignar Ejercicio</h2>
                    <button class="close-btn" id="closeUnassignExerciseModal">&times;</button>
                </div>
                <div class="mt-12">
                    <input type="hidden" id="unassignExerciseId">
                    <p id="unassignExerciseInfo" class="muted mb-12"></p>
                    <label class="form-label">Selecciona miembro (o deja vac√≠o para desasignar a todos)</label>
                    <select id="unassignMemberSelect" class="form-input">
                        <option value="">-- Desasignar a todos --</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelUnassignExercise">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmUnassignExercise">Desasignar</button>
                </div>
                <div id="unassignExerciseError" class="error-message"></div>
                <div id="unassignExerciseSuccess" class="success-message"></div>
            </div>
            </div>
        <!-- Edit Assignment Modal -->
        <div id="editAssignmentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Editar Asignaci√≥n</h2>
                    <button class="close-btn" id="closeEditAssignmentModal">&times;</button>
                </div>
                <div class="mt-12">
                    <input type="hidden" id="editAssignExerciseId">
                    <label class="form-label">Miembro</label>
                    <select id="editAssignMemberSelect" class="form-input"></select>
                </div>
                <div class="flex-gap">
                    <div class="flex-1"><label class="form-label">Series (sets)</label><input id="editAssignSets" class="form-input" type="number" min="1" value="3"></div>
                    <div class="flex-1"><label class="form-label">Repeticiones (reps)</label><input id="editAssignReps" class="form-input" type="number" min="1" value="10"></div>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelEditAssignment">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="saveEditAssignment">Guardar</button>
                </div>
                <div id="editAssignError" class="error-message"></div>
                <div id="editAssignSuccess" class="success-message"></div>
            </div>
        </div>
        <!-- Generic Confirm Modal -->
        <div id="confirmModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="confirmModalTitle">Confirmar</h2>
                    <button class="close-btn" id="closeConfirmModal">&times;</button>
                </div>
                <div id="confirmModalBody" class="modal-body"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-secondary" id="cancelConfirm">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmModalOk">Confirmar</button>
                </div>
            </div>
        </div>
    <script>
        // Defensive stubs: if the app hasn't loaded the helpers yet (cached/stale files),
        // provide safe fallbacks so inline handlers or older code won't throw ReferenceError.
        try {
            if (typeof window !== 'undefined') {
                if (typeof window.confirmPrompt !== 'function') {
                    window.confirmPrompt = function(message, callback) {
                        try { const ok = window.confirm(message); callback(!!ok); } catch (e) { console.error(e); }
                    };
                }
                if (typeof window.showConfirm !== 'function') {
                    window.showConfirm = function(message, callback) {
                        try { const ok = window.confirm(message); callback(!!ok); } catch (e) { console.error(e); }
                    };
                }
                // showToast stub: app may call showToast from inline handlers before main.js loads
                if (typeof window.showToast !== 'function') {
                    window.showToast = function(message, opts) {
                        try {
                            const container = document.getElementById('toastContainer');
                            if (!container) { console.log('TOAST:', message); return; }
                            const div = document.createElement('div');
                            div.className = 'toast';
                            if (opts && opts.background) div.style.background = opts.background;
                            if (opts && opts.color) div.style.color = opts.color;
                            div.textContent = message;
                            container.appendChild(div);
                            setTimeout(() => { try { div.remove(); } catch(e){} }, (opts && opts.duration) || 2500);
                        } catch (e) { try { console.log('TOAST:', message); } catch(_){} }
                    };
                }
            }
        } catch (e) { console.error('Error installing confirm stubs', e); }
    </script>
    <script src="main.js?v=20251021T0100"></script>
        <!-- Toast container -->
    <div id="toastContainer" class="toast-container"></div>

    <script type="module">
    import { initFirebase, addClient, addClientWithImages, getClients, signIn, signOut, onAuthStateChanged, getCurrentUser } from './firebase-utils.js';

    // Firebase config
    const firebaseConfig = {
        apiKey: "AIzaSyAJQ_rq6Xbyx5CZTKwymnktihyirpQL9-s",
        authDomain: "radical-fit-db.firebaseapp.com",
        projectId: "radical-fit-db",
        storageBucket: "radical-fit-db.firebasestorage.app",
        messagingSenderId: "549048730247",
        appId: "1:549048730247:web:a59334a472d381219fee22",
        measurementId: "G-FKDBCX7D4M"
    };

    // Initialize
    try {
        initFirebase(firebaseConfig);
    } catch (e) { console.error('Firebase init error', e); }

    // Wire registration form to add clients to Firestore (requires signed-in user)
    const registerForm = document.getElementById('registerForm');
    if (registerForm) {
        registerForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const user = getCurrentUser();
            if (!user) {
                const errEl = document.getElementById('registerError');
                if (errEl) errEl.textContent = 'Debes iniciar sesi√≥n como administrador para registrar miembros.';
                return;
            }
            const data = {
                name: document.getElementById('regName').value,
                phone: document.getElementById('regPhone').value,
                email: document.getElementById('regEmail').value,
                dob: document.getElementById('regDob').value,
                weight: parseFloat(document.getElementById('regWeight').value) || null,
                planType: document.getElementById('regPlanType').value,
                createdAt: new Date()
            };
            try {
                const beforeFile = document.getElementById('regBeforeImg')?.files?.[0] || null;
                const afterFile = document.getElementById('regAfterImg')?.files?.[0] || null;
                let res;
                if (beforeFile || afterFile) {
                    res = await addClientWithImages(data, beforeFile, afterFile);
                } else {
                    res = await addClient(data);
                }
                showToast('Miembro registrado', { background: '#2d9c6e', color: '#fff' });
                // Optionally refresh members table
                await populateMembersTable();
                registerForm.reset();
                document.getElementById('closeRegisterModal')?.click();
            } catch (err) {
                console.error('Add client error', err);
                const errEl = document.getElementById('registerError');
                if (errEl) errEl.textContent = 'Error guardando miembro';
            }
        });
    }

    // Populate members table in admin view
    async function populateMembersTable() {
        const tbody = document.getElementById('membersTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        try {
            const clients = await getClients();
            clients.forEach((c) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td>${c.name || ''}</td>
                    <td>${c.email || ''}</td>
                    <td>${c.phone || ''}</td>
                    <td class="text-center"><button class="btn btn-sm btn-secondary">Marcar</button></td>
                    <td><button class="btn btn-sm btn-primary">Ver</button></td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('totalMembers').textContent = clients.length;
        } catch (err) {
            console.error('Error loading clients', err);
        }
    }

    // Auth UI wiring
    const loginForm = document.getElementById('loginForm');
    if (loginForm) {
        loginForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signIn(email, password);
                showToast('Sesi√≥n iniciada', { background: '#2d9c6e', color: '#fff' });
                document.getElementById('loginError').textContent = '';
            } catch (e) {
                console.error('Login failed', e);
                document.getElementById('loginError').textContent = 'Credenciales inv√°lidas';
            }
        });
    }

    const signOutBtn = document.getElementById('signOutBtn');
    if (signOutBtn) signOutBtn.addEventListener('click', async () => { await signOut(); });

    // React to auth state changes
    onAuthStateChanged((user) => {
        const landing = document.getElementById('landingPage');
        const mainApp = document.getElementById('mainApp');
        if (user) {
            // show admin UI
            landing.classList.add('hidden');
            mainApp.classList.remove('hidden');
            // populate admin data
            populateMembersTable();
            const userEmail = document.getElementById('userEmail');
            if (userEmail) userEmail.textContent = user.email || '';
        } else {
            // show landing/login
            landing.classList.remove('hidden');
            mainApp.classList.add('hidden');
            const userEmail = document.getElementById('userEmail');
            if (userEmail) userEmail.textContent = '';
        }
    });

    </script>


</body>
</html>